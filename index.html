<!DOCTYPE html>
<!--
å®™ã®è¾» - Soranotsuji
Copyright (c) 2026 Soranotsuji Project
Released under the MIT License.
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®™ã®è¾» - Soranotsuji</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; } /* åœ°å›³ã‚’ç”»é¢ã„ã£ã±ã„ã« */
        
        /* æ“ä½œãƒ‘ãƒãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰ */
        #control-panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); /* å°‘ã—é€ã‘ã‚‹ç™½ */
            padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            width: 85%; max-width: 320px;
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚„ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
        input[type="range"] { width: 100%; margin: 10px 0; cursor: pointer; }
        .label-group { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }

        /* å¤ªé™½ãƒ»æœˆ åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ */
        .mode-switch {
            display: flex; gap: 10px; margin-bottom: 10px; background: #e0e0e0; padding: 4px; border-radius: 5px;
        }
        .mode-switch label {
            flex: 1; text-align: center; cursor: pointer; padding: 6px; border-radius: 4px; font-size: 14px; user-select: none;
        }
        .mode-switch input { display: none; } /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ä¸¸ã¯éš ã™ */
        .mode-switch input:checked + span {
            background: #fff; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.2); display: block;
        }
        .mode-switch span { display: block; width: 100%; border-radius: 4px; }

        /* GPSãƒœã‚¿ãƒ³ */
        #gps-btn {
            width: 100%; padding: 8px; margin-bottom: 15px;
            background-color: #007bff; color: white; border: none; border-radius: 5px;
            font-size: 14px; cursor: pointer; font-weight: bold;
        }
        #gps-btn:active { background-color: #0056b3; }

        /* åŒºåˆ‡ã‚Šç·š */
        hr { border: 0; border-top: 1px solid #ddd; margin: 10px 0; }
        
        /* æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #info-text { font-size: 0.9em; line-height: 1.6; }
    </style>
</head>
<body>

    <div id="control-panel">
        <h3>ğŸ”­ å®™ã®è¾» <span style="font-size:0.8em; font-weight:normal;">- Soranotsuji</span></h3>
        
        <button id="gps-btn">ğŸ“ ç¾åœ¨åœ°ã‚’å‡ºç™ºç‚¹ã«ã™ã‚‹</button>

        <div class="mode-switch">
            <label><input type="radio" name="mode" value="sun" checked><span>ğŸŒ å¤ªé™½</span></label>
            <label><input type="radio" name="mode" value="moon"><span>ğŸŒ› æœˆ</span></label>
        </div>

        <div class="label-group">
            <label>æ—¥ä»˜:</label> <input type="date" id="dateInput">
        </div>

        <div class="label-group">
            <label>æ™‚åˆ»:</label> <span id="timeDisplay">12:00</span>
        </div>
        <input type="range" id="timeSlider" min="0" max="1439" value="720">

        <hr>

        <div id="info-text">
            <span id="targetName">å¤ªé™½</span>ã®æ–¹ä½: <b><span id="azimuth">--</span>Â°</b><br>
            <span id="targetName2">å¤ªé™½</span>ã®é«˜åº¦: <b><span id="altitude">--</span>Â°</b><br>
            <span id="moonPhaseInfo" style="display:none; color: #555; margin-top:5px;">
                æœˆé½¢: <span id="moonPhase">--</span>
            </span>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>

    <script>
        // --- 1. è¨ˆç®—ç”¨é–¢æ•°ï¼ˆæ•°å­¦çš„ãªå‡¦ç†ï¼‰ ---
        function toRadians(d) { return d * Math.PI / 180; }
        function toDegrees(r) { return r * 180 / Math.PI; }

        // 2ç‚¹é–“ã®æ–¹ä½è§’ã‚’è¨ˆç®—
        function calculateBearing(lat1, lng1, lat2, lng2) {
            var Ï†1 = toRadians(lat1), Ï†2 = toRadians(lat2);
            var Î”Î» = toRadians(lng2 - lng1);
            var y = Math.sin(Î”Î») * Math.cos(Ï†2);
            var x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
            return (toDegrees(Math.atan2(y, x)) + 360) % 360;
        }

        // ã‚ã‚‹åœ°ç‚¹ã‹ã‚‰ã€æŒ‡å®šã—ãŸè·é›¢ãƒ»è§’åº¦ã®å ´æ‰€ã‚’æ±‚ã‚ã‚‹ï¼ˆç·šã‚’å¼•ããŸã‚ï¼‰
        function computeDestinationPoint(lat, lng, distanceKm, bearing) {
            var R = 6371; // åœ°çƒåŠå¾„
            var Î´ = distanceKm / R;
            var Î¸ = toRadians(bearing);
            var Ï†1 = toRadians(lat), Î»1 = toRadians(lng);
            var Ï†2 = Math.asin(Math.sin(Ï†1) * Math.cos(Î´) + Math.cos(Ï†1) * Math.sin(Î´) * Math.cos(Î¸));
            var Î»2 = Î»1 + Math.atan2(Math.sin(Î¸) * Math.sin(Î´) * Math.cos(Ï†1), Math.cos(Î´) - Math.sin(Ï†1) * Math.sin(Ï†2));
            return [toDegrees(Ï†2), toDegrees(Î»2)];
        }


        // --- 2. åœ°å›³ã®åˆæœŸè¨­å®š ---
        var startLat = 35.681236; // åˆæœŸå€¤ï¼šæ±äº¬é§…
        var startLng = 139.767125;
        
        // åœ°å›³ã‚’ä½œæˆ
        var map = L.map('map').setView([startLat, startLng], 14);

        // å›½åœŸåœ°ç†é™¢ã®åœ°å›³ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨
        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>å›½åœŸåœ°ç†é™¢</a>"
        }).addTo(map);

        // å‡ºç™ºç‚¹ã®ãƒãƒ¼ã‚«ãƒ¼
        var startMarker = L.marker([startLat, startLng]).addTo(map).bindPopup("å‡ºç™ºç‚¹").openPopup();

        // æç”»ç”¨ã®å¤‰æ•°ã‚’æº–å‚™
        var celestialLine = null; // å¤ªé™½ãƒ»æœˆã®ç·š
        var destLine = null;      // ç›®çš„åœ°ã®èµ¤ç·š


        // --- 3. UIãƒ‘ãƒ¼ãƒ„ã®å–å¾— ---
        var dateInput = document.getElementById('dateInput');
        var timeSlider = document.getElementById('timeSlider');
        var timeDisplay = document.getElementById('timeDisplay');
        var modeRadios = document.getElementsByName('mode');
        var gpsBtn = document.getElementById('gps-btn');

        // ä»Šæ—¥ã®æ—¥æ™‚ã‚’åˆæœŸã‚»ãƒƒãƒˆ
        var now = new Date();
        dateInput.valueAsDate = now;
        timeSlider.value = now.getHours() * 60 + now.getMinutes();


        // --- 4. GPSãƒœã‚¿ãƒ³ã®å‹•ä½œ ---
        gpsBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert("ã“ã®ç«¯æœ«ã§ã¯GPSãŒä½¿ãˆã¾ã›ã‚“ã€‚");
                return;
            }
            gpsBtn.textContent = "æ¸¬ä½ä¸­..."; 
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // æˆåŠŸæ™‚
                    startLat = position.coords.latitude;
                    startLng = position.coords.longitude;
                    
                    // åœ°å›³ã¨ãƒãƒ¼ã‚«ãƒ¼ã‚’ç§»å‹•
                    map.setView([startLat, startLng], 15);
                    startMarker.setLatLng([startLat, startLng]).bindPopup("ã“ã“ãŒç¾åœ¨åœ°ã§ã™").openPopup();
                    
                    // ç›®çš„åœ°ã®ç·šãŒã‚ã‚Œã°æ¶ˆã™
                    if(destLine) { map.removeLayer(destLine); destLine = null; }
                    
                    // å†è¨ˆç®—
                    updateSimulation();
                    gpsBtn.textContent = "ğŸ“ ç¾åœ¨åœ°ã‚’å‡ºç™ºç‚¹ã«ã™ã‚‹";
                },
                function(error) {
                    // å¤±æ•—æ™‚
                    alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nç«¯æœ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    gpsBtn.textContent = "ğŸ“ ç¾åœ¨åœ°ã‚’å‡ºç™ºç‚¹ã«ã™ã‚‹";
                }
            );
        });


        // --- 5. ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–° ---
        function updateSimulation() {
            // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ç¢ºèª (sun or moon)
            var currentMode = 'sun';
            for(var i=0; i<modeRadios.length; i++){
                if(modeRadios[i].checked) currentMode = modeRadios[i].value;
            }

            // æ—¥æ™‚ã®è¨ˆç®—
            var selectedDate = new Date(dateInput.value);
            var minutes = parseInt(timeSlider.value);
            selectedDate.setHours(Math.floor(minutes / 60));
            selectedDate.setMinutes(minutes % 60);
            
            // æ™‚åˆ»è¡¨ç¤ºã‚’æ›´æ–° (00:00å½¢å¼)
            timeDisplay.textContent = ('00' + selectedDate.getHours()).slice(-2) + ':' + ('00' + selectedDate.getMinutes()).slice(-2);

            // è¨ˆç®—çµæœã®å¤‰æ•°
            var azimuth = 0, altitude = 0, color = '', labelName = '';

            if (currentMode === 'sun') {
                // å¤ªé™½ãƒ¢ãƒ¼ãƒ‰
                var sunPos = SunCalc.getPosition(selectedDate, startLat, startLng);
                azimuth = (toDegrees(sunPos.azimuth) + 180) % 360;
                altitude = toDegrees(sunPos.altitude);
                color = '#FFD700'; // é‡‘è‰²
                labelName = 'å¤ªé™½';
                document.getElementById('moonPhaseInfo').style.display = 'none';

            } else {
                // æœˆãƒ¢ãƒ¼ãƒ‰
                var moonPos = SunCalc.getMoonPosition(selectedDate, startLat, startLng);
                azimuth = (toDegrees(moonPos.azimuth) + 180) % 360;
                altitude = toDegrees(moonPos.altitude);
                color = '#4da6ff'; // é’è‰²
                labelName = 'æœˆ';
                
                // æœˆé½¢ã®è¡¨ç¤º
                document.getElementById('moonPhaseInfo').style.display = 'block';
                var moonIllum = SunCalc.getMoonIllumination(selectedDate);
                var phaseText = "";
                // æœˆã®æº€ã¡æ¬ ã‘åˆ¤å®š
                if(moonIllum.phase < 0.05 || moonIllum.phase > 0.95) phaseText = "æ–°æœˆğŸŒ‘";
                else if(moonIllum.phase < 0.2) phaseText = "ä¸‰æ—¥æœˆğŸŒ™";
                else if(moonIllum.phase < 0.3) phaseText = "ä¸Šå¼¦ã®æœˆğŸŒ“";
                else if(moonIllum.phase < 0.45) phaseText = "æº€ã¡ã¦ã„ãæœˆğŸŒ”";
                else if(moonIllum.phase < 0.55) phaseText = "æº€æœˆğŸŒ•";
                else if(moonIllum.phase < 0.7) phaseText = "æ¬ ã‘ã¦ã„ãæœˆğŸŒ–";
                else if(moonIllum.phase < 0.8) phaseText = "ä¸‹å¼¦ã®æœˆğŸŒ—";
                else phaseText = "æœ‰æ˜ã®æœˆğŸŒ˜";
                document.getElementById('moonPhase').textContent = phaseText;
            }

            // ç”»é¢ã®æ•°å€¤ã‚’æ›´æ–°
            document.getElementById('targetName').textContent = labelName;
            document.getElementById('targetName2').textContent = labelName;
            document.getElementById('azimuth').textContent = azimuth.toFixed(1);
            document.getElementById('altitude').textContent = altitude.toFixed(1);

            // åœ°å›³ä¸Šã®ç·šã‚’å¼•ã
            var destPoint = computeDestinationPoint(startLat, startLng, 50, azimuth); // 50kmå…ˆã¾ã§
            
            if (celestialLine) { map.removeLayer(celestialLine); }

            // åœ°å¹³ç·šã‚ˆã‚Šä¸‹ãªã‚‰æš—ãã™ã‚‹æ¼”å‡º
            var lineOpacity = altitude > 0 ? 0.8 : 0.2;
            var lineColor = altitude > 0 ? color : '#555'; 

            celestialLine = L.polyline([[startLat, startLng], destPoint], {
                color: lineColor, weight: 7, opacity: lineOpacity
            }).addTo(map);
        }


        // --- 6. ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚„æ—¥ä»˜ã‚’å¤‰ãˆãŸã‚‰å†è¨ˆç®—
        timeSlider.addEventListener('input', updateSimulation);
        dateInput.addEventListener('change', updateSimulation);
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã‚‚å†è¨ˆç®—
        for(var i=0; i<modeRadios.length; i++){
            modeRadios[i].addEventListener('change', updateSimulation);
        }

        // åœ°å›³ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼ˆç›®çš„åœ°è¨­å®šï¼‰
        map.on('click', function(e) {
            var destLat = e.latlng.lat;
            var destLng = e.latlng.lng;
            var bearing = calculateBearing(startLat, startLng, destLat, destLng);

            // å‰ã®èµ¤ã„ç·šã‚’æ¶ˆã™
            if (destLine) { map.removeLayer(destLine); }
            
            // èµ¤ã„ç·šã‚’å¼•ã
            destLine = L.polyline(
                [ [startLat, startLng], [destLat, destLng] ],
                { color: 'red', weight: 4 }
            ).addTo(map);
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
            L.popup()
                .setLatLng(e.latlng)
                .setContent("ç›®çš„åœ°ã®æ–¹ä½: <b>" + bearing.toFixed(1) + "åº¦</b>")
                .openOn(map);
        });

        // æœ€åˆã®1å›ã‚’å®Ÿè¡Œ
        updateSimulation();

    </script>
</body>
</html>